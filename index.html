<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f19" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="apple-touch-icon" href="./icon-192.png" />
  <title>ä¸ªäººæ‰§è¡Œç³»ç»Ÿ Â· To-Do + æ‰§è¡Œå—</title>
  <style>
    :root{
      --bg:#0b0f19;
      --card:#101827;
      --muted:#93a4c7;
      --text:#eaf0ff;
      --line:#1f2a44;
      --good:#4ade80;
      --warn:#fbbf24;
      --bad:#fb7185;
      --accent:#60a5fa;
      --accent2:#a78bfa;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Hiragino Sans GB","Microsoft YaHei","Noto Sans CJK SC",Helvetica,Arial,sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(96,165,250,.18), transparent 55%),
        radial-gradient(700px 520px at 85% 25%, rgba(167,139,250,.16), transparent 60%),
        var(--bg);
      color:var(--text);
      font-family:var(--sans);
      padding-bottom: env(safe-area-inset-bottom);
    }

    /* Mobile-first layout */
    header{
      position: sticky;
      top:0;
      z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(11,15,25,.75);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .headerInner{
      max-width: 1180px;
      margin: 0 auto;
      padding: 14px 14px 10px;
      display:flex;
      gap:10px;
      align-items:flex-end;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    h1{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .subtitle{
      margin-top:6px;
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .row > *{flex:1}
    a{color:#b9d7ff}

    .container{
      max-width: 1180px;
      margin: 0 auto;
      padding: 12px 14px 70px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 980px){
      .container{grid-template-columns: 1.15fr .85fr; gap:14px;}
      h1{font-size:18px}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent 35%), var(--card);
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:12px;
    }
    .card h2{
      margin: 0 0 10px;
      font-size: 13px;
      color:#dbe7ff;
      letter-spacing:.2px;
    }
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px;}
    input, select, textarea, button{
      font: inherit;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 10px 11px;
      outline:none;
    }
    textarea{min-height: 86px; resize: vertical; line-height:1.55}
    input::placeholder, textarea::placeholder{color: rgba(147,164,199,.7)}
    button{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(96,165,250,.30), rgba(96,165,250,.10));
      transition: transform .05s ease, filter .2s ease;
      font-weight:650;
      white-space:nowrap;
    }
    button:hover{filter:brightness(1.05)}
    button:active{transform: translateY(1px)}
    .btn2{
      background: linear-gradient(180deg, rgba(167,139,250,.30), rgba(167,139,250,.10));
    }
    .btnGhost{
      background: rgba(255,255,255,.02);
      font-weight:650;
    }
    .btnDanger{
      background: linear-gradient(180deg, rgba(251,113,133,.30), rgba(251,113,133,.10));
      border-color: rgba(251,113,133,.25);
    }
    .small{font-size:12px; color:var(--muted); line-height:1.45}
    .divider{height:1px; background: rgba(255,255,255,.08); margin: 12px 0;}

    /* Tabs (mobile navigation) */
    .tabs{
      display:flex;
      gap:8px;
      margin-top:10px;
    }
    .tab{
      flex:1;
      padding:10px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
      color: var(--muted);
      font-weight:700;
      text-align:center;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background: linear-gradient(180deg, rgba(96,165,250,.22), rgba(255,255,255,.02));
      color: var(--text);
      border-color: rgba(96,165,250,.30);
    }

    /* Lists */
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 360px;
      overflow:auto;
      padding-right:2px;
    }
    @media (min-width: 980px){
      .list{max-height: 420px;}
    }
    .item{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
      border-radius: 14px;
      padding:10px;
    }
    .itemTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .itemTitle{font-weight:800; font-size:13px}
    .tag{
      font-size:11px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;
      padding:5px 8px;
      color: var(--muted);
      white-space:nowrap;
    }
    .itemBody{margin-top:8px; color:#d6e1ff; font-size:12px; line-height:1.55; white-space:pre-wrap}

    /* KPI */
    .kpi{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 520px){
      .kpi{grid-template-columns:1fr}
    }
    .kpi .box{
      padding:12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
    }
    .kpi .num{
      font-family: var(--mono);
      font-size: 22px;
      margin-top: 6px;
      color:#f2f6ff;
    }
    canvas{width:100%; height: 180px; border-radius: 14px; border:1px solid rgba(255,255,255,.08); background: rgba(255,255,255,.02)}

    /* Timer */
    .timer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
    }
    .time{
      font-family: var(--mono);
      font-size: 28px;
      letter-spacing: .5px;
    }

    /* Today module */
    .twoCol{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media (min-width: 980px){
      .twoCol{grid-template-columns:1fr 1fr;}
    }

    /* Bottom install bar on mobile */
    .bottomBar{
      position: fixed;
      left:0; right:0;
      bottom:0;
      z-index:20;
      background: rgba(11,15,25,.88);
      border-top:1px solid rgba(255,255,255,.06);
      backdrop-filter: blur(10px);
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      display:none;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .bottomBar .hint{color:var(--muted); font-size:12px; line-height:1.4}
    .toast{
      position: fixed;
      left: 50%;
      bottom: calc(16px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      background: rgba(15,23,42,.92);
      border:1px solid rgba(255,255,255,.10);
      padding:10px 12px;
      border-radius: 999px;
      box-shadow: var(--shadow);
      color:#eef4ff;
      font-size:12px;
      opacity:0;
      pointer-events:none;
      transition: opacity .25s ease, transform .25s ease;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-2px);
    }
    .hl-good{color:var(--good)}
    .hl-warn{color:var(--warn)}
    .hl-bad{color:var(--bad)}
    .help{
      color:var(--muted);
      font-size:12px;
      line-height:1.55;
      padding:10px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.12);
      background: rgba(255,255,255,.02);
    }

    /* Modal */
    .modalMask{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:50;
    }
    .modal{
      width:min(560px, 100%);
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(16,24,39,.96);
      box-shadow: var(--shadow);
      padding:12px;
    }
    .modal h3{margin:0 0 8px; font-size:14px}
    .modalActions{display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; margin-top:10px;}
  </style>
</head>
<body>

<header>
  <div class="headerInner">
    <div>
      <h1>ä¸ªäººæ‰§è¡Œç³»ç»Ÿï¼ˆæ‰‹æœºä¼˜å…ˆ + PWAï¼‰</h1>
      <div class="subtitle">
        To-Do å¤šåˆ—è¡¨ + ä»Šæ—¥æ¨¡å— + æ‰§è¡Œå—å¼ºåˆ¶è¾“å‡º + å¥–åŠ±/è¿ç»­å¤©æ•°ã€‚æ•°æ®ä¿å­˜åœ¨æœ¬åœ°ï¼Œä¸è”ç½‘ã€‚
      </div>
      <div class="tabs" style="max-width:520px;">
        <div class="tab active" data-tab="todo">To-Do</div>
        <div class="tab" data-tab="block">æ‰§è¡Œå—</div>
        <div class="tab" data-tab="today">ä»Šæ—¥</div>
        <div class="tab" data-tab="stats">ç»Ÿè®¡</div>
      </div>
    </div>

    <div class="row" style="flex:0 0 auto;">
      <span class="pill" id="todayPill">ä»Šå¤©ï¼š-</span>
      <button class="btnGhost" id="manageCatsBtn" style="flex:0 0 auto;">ç®¡ç†åˆ†ç±»</button>
      <button class="btnGhost" id="exportBtn" style="flex:0 0 auto;">å¯¼å‡º</button>
      <button class="btnDanger" id="resetBtn" style="flex:0 0 auto;">æ¸…ç©º</button>
    </div>
  </div>
</header>

<main class="container">
  <!-- LEFT column -->
  <section class="card" id="panelTodo">
    <h2>â‘  å¤šä¸ª To-Do List</h2>

    <div class="row">
      <div>
        <label>é€‰æ‹©åˆ—è¡¨</label>
        <select id="todoListSelect"></select>
      </div>
      <div>
        <label>æ–°å»ºåˆ—è¡¨</label>
        <div class="row" style="gap:8px; flex-wrap:nowrap;">
          <input id="newListName" placeholder="å¦‚ï¼šè€ƒè¯•å†²åˆº / å·¥ä½œ / ç”Ÿæ´»" />
          <button id="addListBtn" style="flex:0 0 auto;">æ–°å»º</button>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="btnGhost" id="renameListBtn">é‡å‘½ååˆ—è¡¨</button>
      <button class="btnDanger" id="deleteListBtn">åˆ é™¤åˆ—è¡¨</button>
      <div class="small" style="flex: 2 1 100%;">
        åˆ—è¡¨ç”¨äºâ€œè£…ä»»åŠ¡â€ï¼šä½ å¯ä»¥æŒ‰ç§‘ç›®/é¡¹ç›®/åœºæ™¯åˆ†å¤šä¸ªæ¸…å•ï¼ˆå­¦ä¹ ã€å·¥ä½œã€ç”Ÿæ´»ç­‰ï¼‰ã€‚
      </div>
    </div>

    <div class="divider"></div>

    <div class="row">
      <div style="flex:1 1 100%;">
        <label>æ–°å¢ To-Doï¼ˆå¯é€‰åˆ†ç±»/é¡¹ç›®ï¼‰</label>
        <div class="row" style="gap:8px;">
          <input id="todoTitle" placeholder="å†™æ¸…ä¸€ä¸ªå¯æ‰§è¡ŒåŠ¨ä½œï¼ˆè¶Šå°è¶Šå¥½ï¼‰" style="flex:2" />
          <select id="todoCat" style="flex:1"></select>
        </div>
        <div class="row" style="gap:8px; margin-top:8px;">
          <select id="todoPriority" style="flex:1">
            <option value="2">ä¼˜å…ˆçº§ï¼šé«˜</option>
            <option value="1" selected>ä¼˜å…ˆçº§ï¼šä¸­</option>
            <option value="0">ä¼˜å…ˆçº§ï¼šä½</option>
          </select>
          <select id="todoEstimate" style="flex:1">
            <option value="15">é¢„è®¡ 15 åˆ†é’Ÿ</option>
            <option value="30" selected>é¢„è®¡ 30 åˆ†é’Ÿ</option>
            <option value="45">é¢„è®¡ 45 åˆ†é’Ÿ</option>
            <option value="60">é¢„è®¡ 60 åˆ†é’Ÿ</option>
            <option value="90">é¢„è®¡ 90 åˆ†é’Ÿ</option>
          </select>
          <button id="addTodoBtn" style="flex:0 0 auto;">æ·»åŠ </button>
        </div>
        <div class="small" style="margin-top:6px;">
          å»ºè®®ï¼šæŠŠä»»åŠ¡æ‹†åˆ°â€œç°åœ¨å°±èƒ½å¼€å§‹â€çš„åŠ¨ä½œï¼Œå¹¶ç»‘å®šè¾“å‡ºï¼ˆå¦‚ï¼šå†™ 5 ä¸ªè¦ç‚¹ã€åš 10 é¢˜ã€æ”¹ 3 ä¸ª bugï¼‰ã€‚
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="row" style="align-items:flex-end;">
      <div>
        <label>ç­›é€‰</label>
        <select id="todoFilter">
          <option value="open" selected>æœªå®Œæˆ</option>
          <option value="done">å·²å®Œæˆ</option>
          <option value="all">å…¨éƒ¨</option>
        </select>
      </div>
      <div>
        <label>æ’åº</label>
        <select id="todoSort">
          <option value="priority" selected>æŒ‰ä¼˜å…ˆçº§</option>
          <option value="estimate">æŒ‰é¢„è®¡æ—¶é•¿</option>
          <option value="created">æŒ‰åˆ›å»ºæ—¶é—´</option>
        </select>
      </div>
      <button class="btnGhost" id="addToBlockBtn" style="flex: 1 1 220px;">
        é€‰ä¸­ To-Do â†’ å¡«å…¥æ‰§è¡Œå—ç›®æ ‡
      </button>
    </div>

    <div class="divider"></div>

    <div class="list" id="todoList"></div>
  </section>

  <section class="card" id="panelBlock" style="display:none;">
    <h2>â‘¡ æ‰§è¡Œå—ï¼ˆå¼ºåˆ¶ç¡¬è¾“å‡ºï¼‰</h2>

    <div class="row">
      <div>
        <label>åˆ†ç±»/é¡¹ç›®ï¼ˆç”¨äºç»Ÿè®¡ï¼‰</label>
        <select id="blockCat"></select>
        <div class="small">å®ƒçš„ä½œç”¨ï¼šç»™æ‰§è¡Œå—æ‰“æ ‡ç­¾ï¼Œæ–¹ä¾¿ä½ å›çœ‹â€œä»Šå¤©åˆ°åº•åœ¨å¹²ä»€ä¹ˆâ€ã€‚</div>
      </div>
      <div>
        <label>æ‰§è¡Œå—ç±»å‹</label>
        <select id="blockType">
          <option value="deep">æ ‡å‡†å— 90 åˆ†é’Ÿï¼ˆæ·±åº¦ï¼‰</option>
          <option value="light">è½»é‡å— 45 åˆ†é’Ÿï¼ˆå¯åŠ¨/çŠ¶æ€å·®ï¼‰</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div style="flex:1 1 100%;">
        <label>æœ¬æ‰§è¡Œå—ç›®æ ‡ï¼ˆå¿…é¡»å†™ï¼‰</label>
        <input id="goalInput" placeholder="ä¸€å¥è¯å†™æ¸…ï¼šæœ¬å—è¦å®Œæˆä»€ä¹ˆï¼Ÿ" />
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>å¯åŠ¨é”šç‚¹ï¼ˆå¼€å§‹æ—¶æç¤ºï¼‰</label>
        <select id="anchorSelect">
          <option value="å†™ä¸‹ç›®æ ‡ + æ¸…æ¡Œé¢ 2 åˆ†é’Ÿ">å†™ä¸‹ç›®æ ‡ + æ¸…æ¡Œé¢ 2 åˆ†é’Ÿ</option>
          <option value="å€’è®¡æ—¶ 10 ç§’ + æ·±å‘¼å¸ 3 æ¬¡">å€’è®¡æ—¶ 10 ç§’ + æ·±å‘¼å¸ 3 æ¬¡</option>
          <option value="æ‰“å¼€ææ–™ + å…ˆåš 1 ä¸ªæœ€å°åŠ¨ä½œ">æ‰“å¼€ææ–™ + å…ˆåš 1 ä¸ªæœ€å°åŠ¨ä½œ</option>
          <option value="å–æ°´ + æˆ´è€³å¡/é™å™ª">å–æ°´ + æˆ´è€³å¡/é™å™ª</option>
        </select>
      </div>
      <div>
        <label>å¾®å¥–åŠ±ï¼ˆâ‰¤10 åˆ†é’Ÿï¼‰</label>
        <select id="microReward">
          <option value="å–æ°´ + èµ°åŠ¨ 2 åˆ†é’Ÿ">å–æ°´ + èµ°åŠ¨ 2 åˆ†é’Ÿ</option>
          <option value="æ‹‰ä¼¸ 5 åˆ†é’Ÿ">æ‹‰ä¼¸ 5 åˆ†é’Ÿ</option>
          <option value="å¬ 1-2 é¦–æ­Œï¼ˆâ‰¤10 åˆ†é’Ÿï¼‰">å¬ 1-2 é¦–æ­Œï¼ˆâ‰¤10 åˆ†é’Ÿï¼‰</option>
          <option value="é—­çœ¼ä¼‘æ¯ 3 åˆ†é’Ÿ">é—­çœ¼ä¼‘æ¯ 3 åˆ†é’Ÿ</option>
        </select>
      </div>
    </div>

    <div class="divider"></div>

    <div class="timer">
      <div>
        <div class="small" id="blockMeta">æœªå¼€å§‹</div>
        <div class="time" id="timeDisplay">00:00</div>
      </div>
      <div class="row" style="flex:0 0 auto; gap:8px;">
        <button id="startBtn">å¼€å§‹</button>
        <button id="pauseBtn" class="btnGhost">æš‚åœ</button>
        <button id="finishBtn" class="btn2">å®Œæˆç™»è®°</button>
      </div>
    </div>

    <div class="divider"></div>

    <div class="row">
      <div style="flex:1 1 100%;">
        <label>å¼ºåˆ¶ç¡¬è¾“å‡ºï¼ˆå¿…é¡»å†™ï¼Œå†™å®Œæ‰ç®—å®Œæˆï¼‰</label>
        <textarea id="outputInput" placeholder="å»ºè®®æ¨¡æ¿ï¼š&#10;1) æˆ‘å®Œæˆäº†ï¼š...&#10;2) å…³é”®ç‚¹/é”™å› ï¼š...ï¼ˆè‡³å°‘ 3 æ¡ï¼‰&#10;3) ä¸‹ä¸€æ­¥ï¼š..."></textarea>
        <div class="small">è§„åˆ™ï¼šæ²¡æœ‰ç¡¬è¾“å‡º = æœ¬å—ä¸è®¡å…¥å®Œæˆã€‚</div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="row">
      <button id="quickLightBtn" class="btnGhost">åˆ‡æ¢ï¼šè½»é‡å—</button>
      <button id="quickDeepBtn" class="btnGhost">åˆ‡æ¢ï¼šæ ‡å‡†å—</button>
      <button id="quickLogBtn" class="btnGhost">æ— éœ€è®¡æ—¶ï¼šç›´æ¥ç™»è®°</button>
    </div>

    <div class="help" style="margin-top:10px;">
      <b>ç»“æ„å»ºè®®</b><br/>
      æ ‡å‡†å—ï¼šå¯åŠ¨ 5m â†’ æ ¸å¿ƒæ‰§è¡Œ 40m â†’ è¾“å‡º 10m â†’ ä¼‘æ¯ 10m â†’ å·©å›º 25m<br/>
      è½»é‡å—ï¼šå¯åŠ¨ 5m â†’ æ‰§è¡Œ 25m â†’ è¾“å‡º 5m â†’ å›é¡¾+ä¼‘æ¯ 10m
    </div>
  </section>

  <!-- RIGHT column -->
  <aside class="card" id="panelToday" style="display:none;">
    <h2>â‘¢ ä»Šæ—¥æˆ‘åšäº†ä»€ä¹ˆ</h2>

    <div class="twoCol">
      <div class="card" style="box-shadow:none;">
        <h2 style="margin-bottom:8px;">ä»Šæ—¥å®Œæˆçš„ To-Do</h2>
        <div class="list" id="todayDoneTodos"></div>
      </div>
      <div class="card" style="box-shadow:none;">
        <h2 style="margin-bottom:8px;">ä»Šæ—¥å®Œæˆçš„ æ‰§è¡Œå—</h2>
        <div class="list" id="todayBlocksList"></div>
      </div>
    </div>
  </aside>

  <aside class="card" id="panelStats" style="display:none;">
    <h2>â‘£ ç»Ÿè®¡ / å¥–åŠ± / è¶‹åŠ¿</h2>

    <div class="card" style="box-shadow:none;">
      <h2 style="margin-bottom:8px;">ä»Šæ—¥è®¡åˆ’ & KPI</h2>

      <div class="row">
        <div>
          <label>ä»Šæ—¥è®¡åˆ’æ‰§è¡Œå—ï¼ˆNï¼‰</label>
          <input id="planBlocks" type="number" min="0" step="1" placeholder="å¦‚ï¼š4" />
        </div>
        <div>
          <label>å½“æ—¥è¾¾æˆå¥–åŠ±é˜ˆå€¼ï¼ˆâ‰¥X å—ï¼‰</label>
          <input id="dailyRewardThreshold" type="number" min="0" step="1" placeholder="å¦‚ï¼š2" />
        </div>
        <div class="row" style="flex:0 0 auto;">
          <button id="savePlanBtn" class="btn2">ä¿å­˜</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="kpi" style="margin-bottom:10px;">
        <div class="box">
          <div class="small">ä»Šæ—¥å®Œæˆæ‰§è¡Œå—</div>
          <div class="num" id="kpiBlocks">0</div>
        </div>
        <div class="box">
          <div class="small">ä»Šæ—¥å®Œæˆç‡</div>
          <div class="num" id="kpiRate">0%</div>
        </div>
        <div class="box">
          <div class="small">è¿ç»­è¾¾æ ‡å¤©æ•°ï¼ˆâ‰¥70%ï¼‰</div>
          <div class="num" id="kpiStreak">0</div>
        </div>
      </div>

      <div class="help" id="rewardStatus">-</div>

      <div class="row" style="margin-top:10px;">
        <button id="claimDailyBtn" class="btn2">æˆ‘å·²é¢†å–å½“æ—¥å¥–åŠ±</button>
        <button id="claimWeeklyBtn" class="btn2">æˆ‘å·²é¢†å–å‘¨æœŸå¥–åŠ±</button>
      </div>
      <div class="small" style="margin-top:8px;">é¢†å–æŒ‰é’®ç”¨äºé˜²æ­¢é‡å¤æç¤ºï¼Œä¸å½±å“ç»Ÿè®¡ã€‚</div>
    </div>

    <div class="divider"></div>

    <div class="card" style="box-shadow:none;">
      <h2 style="margin-bottom:8px;">è¿‘ 7 å¤©å®Œæˆç‡</h2>
      <canvas id="chart" width="900" height="320"></canvas>
      <div class="small" style="margin-top:8px;">
        å£å¾„ï¼šå®Œæˆç‡ = å®Œæˆå—æ•° / è®¡åˆ’å—æ•°ï¼ˆè®¡åˆ’ä¸º 0 æŒ‰ 100%ï¼‰
      </div>
    </div>
  </aside>
</main>

<!-- Manage Categories Modal -->
<div class="modalMask" id="catModalMask">
  <div class="modal">
    <h3>ç®¡ç†åˆ†ç±»/é¡¹ç›®</h3>
    <div class="small" style="margin-bottom:10px;">
      åˆ†ç±»çš„ç”¨é€”ï¼šç»™ To-Do å’Œæ‰§è¡Œå—æ‰“æ ‡ç­¾ï¼ˆå­¦ä¹ /å·¥ä½œ/å‰¯ä¸š/å¥èº«â€¦ï¼‰ï¼Œæ–¹ä¾¿ç­›é€‰ä¸å›çœ‹ã€‚æ”¯æŒæ–°å¢/é‡å‘½å/åˆ é™¤ã€‚
    </div>

    <div class="row">
      <div>
        <label>æ–°å¢åˆ†ç±»</label>
        <div class="row" style="gap:8px; flex-wrap:nowrap;">
          <input id="newCatName" placeholder="å¦‚ï¼šæ•°å­¦ / å·¥ä½œ / å‰¯ä¸š" />
          <button id="addCatBtn" style="flex:0 0 auto;">æ·»åŠ </button>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="list" id="catList" style="max-height:240px;"></div>

    <div class="modalActions">
      <button class="btnGhost" id="closeCatModalBtn">å…³é—­</button>
    </div>
  </div>
</div>

<!-- Bottom install bar -->
<div class="bottomBar" id="installBar">
  <div class="hint">
    æƒ³åƒ App ä¸€æ ·ä½¿ç”¨ï¼Ÿ<br/>ç‚¹å‡»å®‰è£…åˆ°ä¸»å±å¹•ï¼ˆæ”¯æŒç¦»çº¿ï¼‰ã€‚
  </div>
  <div class="row" style="flex:0 0 auto; gap:8px;">
    <button class="btn2" id="installBtn">å®‰è£…</button>
    <button class="btnGhost" id="dismissInstallBtn">ä»¥åå†è¯´</button>
  </div>
</div>

<div class="toast" id="toast">æç¤º</div>

<script>
/* =========================
   Storage model (v2)
   ========================= */
const STORE_KEY = "execution_os_v2";

function todayKey(d = new Date()){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const da = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${da}`;
}
function nowHM(){
  const d = new Date();
  return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
}
function loadState(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw){
      return {
        // "åˆ†ç±»/é¡¹ç›®"ï¼šç”¨äºç»™ todo & block æ‰“æ ‡ç­¾
        categories: ["å­¦ä¹ ","å·¥ä½œ","å‰¯ä¸š","å¥èº«","ç”Ÿæ´»"],
        // å¤šä¸ª To-Do åˆ—è¡¨
        todoLists: [
          { id: crypto.randomUUID(), name: "é»˜è®¤æ¸…å•", todos: [] }
        ],
        ui: {
          activeTab: "todo",
          activeTodoListId: null
        },
        settings: {
          dailyRewardThreshold: 2,
          weeklyStreakDays: 3,
          streakRateThreshold: 0.70
        },
        days: {}, // dateKey -> { planBlocks, dailyRewardThreshold, dailyClaimed, logs:[], todoDoneIds:[] }
        weeklyRewardLastClaimedAt: null
      };
    }
    const s = JSON.parse(raw);
    return s;
  }catch(e){
    console.warn("load failed", e);
    return null;
  }
}
let state = loadState();
if(!state){
  state = {
    categories:["å­¦ä¹ ","å·¥ä½œ","å‰¯ä¸š","å¥èº«","ç”Ÿæ´»"],
    todoLists:[{id:crypto.randomUUID(), name:"é»˜è®¤æ¸…å•", todos:[]}],
    ui:{activeTab:"todo", activeTodoListId:null},
    settings:{dailyRewardThreshold:2, weeklyStreakDays:3, streakRateThreshold:0.70},
    days:{},
    weeklyRewardLastClaimedAt:null
  };
}
function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }

/* =========================
   Timer
   ========================= */
let timer = {
  running:false,
  startedAt:null,
  remainingMs:0,
  totalMs:0,
  tickHandle:null
};
function getBlockTotalMs(type){ return (type==="light"?45:90)*60*1000; }
function fmtTime(ms){
  ms = Math.max(0, ms|0);
  const s = Math.floor(ms/1000);
  const mm = Math.floor(s/60);
  const ss = s%60;
  return `${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
}
function stopTick(){
  if(timer.tickHandle){ clearInterval(timer.tickHandle); timer.tickHandle=null; }
}
function startTick(){
  stopTick();
  timer.tickHandle = setInterval(()=>{
    if(!timer.running) return;
    const elapsed = Date.now() - timer.startedAt;
    timer.remainingMs = timer.totalMs - elapsed;
    updateTimerUI();
    if(timer.remainingMs <= 0){
      timer.running = false;
      stopTick();
      timer.remainingMs = 0;
      updateTimerUI();
      toast("è®¡æ—¶ç»“æŸï¼šå†™ç¡¬è¾“å‡º â†’ å®Œæˆç™»è®° âœ…");
    }
  }, 200);
}
function resetTimer(){
  timer.running=false;
  timer.startedAt=null;
  timer.remainingMs=0;
  timer.totalMs=0;
  stopTick();
  updateTimerUI();
}

/* =========================
   DOM helpers
   ========================= */
const $ = (id)=>document.getElementById(id);
const toastEl = $("toast");
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  setTimeout(()=>toastEl.classList.remove("show"), 1900);
}
function ensureDay(key = todayKey()){
  if(!state.days[key]){
    state.days[key] = {
      planBlocks: 0,
      dailyRewardThreshold: state.settings.dailyRewardThreshold ?? 2,
      dailyClaimed: false,
      logs: [],
      todoDoneIds: [] // ids of todos done today (snapshot)
    };
  }
  return state.days[key];
}
function activeTodoList(){
  if(!state.ui.activeTodoListId){
    state.ui.activeTodoListId = state.todoLists[0]?.id ?? null;
  }
  return state.todoLists.find(l => l.id === state.ui.activeTodoListId) || state.todoLists[0];
}

/* =========================
   Tabs / panels
   ========================= */
function setActiveTab(tab){
  state.ui.activeTab = tab;
  saveState();
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.tab === tab);
  });
  $("panelTodo").style.display = (tab==="todo") ? "" : "none";
  $("panelBlock").style.display = (tab==="block") ? "" : "none";
  $("panelToday").style.display = (tab==="today") ? "" : "none";
  $("panelStats").style.display = (tab==="stats") ? "" : "none";
  refreshAll();
}

/* =========================
   Header
   ========================= */
function setTodayPill(){
  const d = new Date();
  const days = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
  $("todayPill").textContent = `ä»Šå¤©ï¼š${todayKey(d)}ï¼ˆå‘¨${days[d.getDay()]}ï¼‰`;
}

/* =========================
   Categories
   ========================= */
function populateCategories(){
  const catSelects = [$("todoCat"), $("blockCat")];
  catSelects.forEach(sel=>{
    if(!sel) return;
    sel.innerHTML="";
    state.categories.forEach(c=>{
      const opt=document.createElement("option");
      opt.value=c; opt.textContent=c;
      sel.appendChild(opt);
    });
  });
}
function openCatModal(){
  $("catModalMask").style.display="flex";
  renderCatList();
}
function closeCatModal(){
  $("catModalMask").style.display="none";
}
function renderCatList(){
  const list = $("catList");
  list.innerHTML="";
  state.categories.forEach((c, idx)=>{
    const item=document.createElement("div");
    item.className="item";
    const top=document.createElement("div");
    top.className="itemTop";
    const title=document.createElement("div");
    title.className="itemTitle";
    title.textContent=c;

    const actions=document.createElement("div");
    actions.className="row";
    actions.style.flex="0 0 auto";
    actions.style.gap="8px";

    const renameBtn=document.createElement("button");
    renameBtn.className="btnGhost";
    renameBtn.textContent="é‡å‘½å";
    renameBtn.onclick=()=>{
      const nv = prompt("è¾“å…¥æ–°åç§°", c);
      if(!nv) return;
      const name = nv.trim();
      if(!name) return;
      if(state.categories.includes(name)) return toast("è¯¥åˆ†ç±»å·²å­˜åœ¨");
      // replace in categories
      state.categories[idx]=name;
      // replace in todos and logs
      state.todoLists.forEach(l=>{
        l.todos.forEach(t=>{ if(t.cat===c) t.cat=name; });
      });
      Object.values(state.days).forEach(day=>{
        (day.logs||[]).forEach(log=>{ if(log.cat===c) log.cat=name; });
      });
      saveState();
      toast("å·²é‡å‘½å");
      populateCategories();
      renderCatList();
      refreshAll();
    };

    const delBtn=document.createElement("button");
    delBtn.className="btnDanger";
    delBtn.textContent="åˆ é™¤";
    delBtn.onclick=()=>{
      if(state.categories.length<=1) return toast("è‡³å°‘ä¿ç•™ 1 ä¸ªåˆ†ç±»");
      if(!confirm(`åˆ é™¤åˆ†ç±»ã€Œ${c}ã€ï¼Ÿï¼ˆä»»åŠ¡/è®°å½•å°†æ”¹ä¸ºã€Œæœªåˆ†ç±»ã€ï¼‰`)) return;

      // remove cat
      state.categories.splice(idx,1);

      // ensure "æœªåˆ†ç±»"
      if(!state.categories.includes("æœªåˆ†ç±»")) state.categories.unshift("æœªåˆ†ç±»");

      // re-map
      const fallback="æœªåˆ†ç±»";
      state.todoLists.forEach(l=>{
        l.todos.forEach(t=>{ if(t.cat===c) t.cat=fallback; });
      });
      Object.values(state.days).forEach(day=>{
        (day.logs||[]).forEach(log=>{ if(log.cat===c) log.cat=fallback; });
      });

      saveState();
      toast("å·²åˆ é™¤åˆ†ç±»");
      populateCategories();
      renderCatList();
      refreshAll();
    };

    actions.appendChild(renameBtn);
    actions.appendChild(delBtn);

    top.appendChild(title);
    top.appendChild(actions);
    item.appendChild(top);
    list.appendChild(item);
  });
}
function addCategory(){
  const v = $("newCatName").value.trim();
  if(!v) return toast("è¯·è¾“å…¥åˆ†ç±»åç§°");
  if(state.categories.includes(v)) return toast("åˆ†ç±»å·²å­˜åœ¨");
  state.categories.push(v);
  $("newCatName").value="";
  saveState();
  populateCategories();
  renderCatList();
  toast("å·²æ·»åŠ åˆ†ç±»");
}

/* =========================
   To-Do Lists
   ========================= */
function populateTodoLists(){
  const sel = $("todoListSelect");
  sel.innerHTML="";
  state.todoLists.forEach(l=>{
    const opt=document.createElement("option");
    opt.value=l.id; opt.textContent=l.name;
    sel.appendChild(opt);
  });
  const active = activeTodoList();
  sel.value = active.id;
}
function addTodoList(){
  const name = $("newListName").value.trim();
  if(!name) return toast("è¯·è¾“å…¥åˆ—è¡¨åç§°");
  const list = { id: crypto.randomUUID(), name, todos: [] };
  state.todoLists.push(list);
  state.ui.activeTodoListId = list.id;
  $("newListName").value="";
  saveState();
  populateTodoLists();
  toast("å·²æ–°å»ºåˆ—è¡¨");
  renderTodos();
}
function renameTodoList(){
  const list = activeTodoList();
  const nv = prompt("æ–°åˆ—è¡¨å", list.name);
  if(!nv) return;
  const name = nv.trim();
  if(!name) return;
  list.name = name;
  saveState();
  populateTodoLists();
  toast("å·²é‡å‘½å");
}
function deleteTodoList(){
  if(state.todoLists.length<=1) return toast("è‡³å°‘ä¿ç•™ 1 ä¸ªåˆ—è¡¨");
  const list = activeTodoList();
  if(!confirm(`åˆ é™¤åˆ—è¡¨ã€Œ${list.name}ã€ï¼Ÿå…¶ä¸­ To-Do ä¼šä¸€å¹¶åˆ é™¤ã€‚`)) return;
  state.todoLists = state.todoLists.filter(l=>l.id!==list.id);
  state.ui.activeTodoListId = state.todoLists[0].id;
  saveState();
  populateTodoLists();
  toast("å·²åˆ é™¤åˆ—è¡¨");
  renderTodos();
}

/* =========================
   To-Do items
   ========================= */
let selectedTodoId = null;

function addTodo(){
  const list = activeTodoList();
  const title = $("todoTitle").value.trim();
  if(!title) return toast("è¯·è¾“å…¥ To-Do å†…å®¹");
  const cat = $("todoCat").value || "æœªåˆ†ç±»";
  const pr = Number($("todoPriority").value);
  const est = Number($("todoEstimate").value);

  const todo = {
    id: crypto.randomUUID(),
    title,
    cat,
    priority: pr,
    estimateMin: est,
    createdAt: Date.now(),
    doneAt: null
  };
  list.todos.push(todo);
  $("todoTitle").value="";
  saveState();
  toast("å·²æ·»åŠ  To-Do");
  renderTodos();
}

function toggleTodoDone(todoId){
  const list = activeTodoList();
  const t = list.todos.find(x=>x.id===todoId);
  if(!t) return;

  const day = ensureDay();
  if(t.doneAt){
    t.doneAt = null;
    day.todoDoneIds = day.todoDoneIds.filter(id=>id!==t.id);
    toast("å·²æ ‡è®°ä¸ºæœªå®Œæˆ");
  }else{
    t.doneAt = Date.now();
    if(!day.todoDoneIds.includes(t.id)) day.todoDoneIds.push(t.id);
    toast("å·²å®Œæˆ âœ…ï¼ˆä¼šå‡ºç°åœ¨ä»Šæ—¥æ¨¡å—ï¼‰");
  }
  saveState();
  renderTodos();
  renderTodayModule();
}

function editTodo(todoId){
  const list = activeTodoList();
  const t = list.todos.find(x=>x.id===todoId);
  if(!t) return;
  const nv = prompt("ä¿®æ”¹ To-Do", t.title);
  if(!nv) return;
  const title = nv.trim();
  if(!title) return;
  t.title = title;
  saveState();
  toast("å·²ä¿®æ”¹");
  renderTodos();
  renderTodayModule();
}

function deleteTodo(todoId){
  const list = activeTodoList();
  const idx = list.todos.findIndex(x=>x.id===todoId);
  if(idx<0) return;
  if(!confirm("åˆ é™¤è¯¥ To-Doï¼Ÿ")) return;

  const t = list.todos[idx];
  // remove from today's done snapshot
  const day = ensureDay();
  day.todoDoneIds = day.todoDoneIds.filter(id=>id!==t.id);

  list.todos.splice(idx,1);
  if(selectedTodoId === todoId) selectedTodoId = null;

  saveState();
  toast("å·²åˆ é™¤ To-Do");
  renderTodos();
  renderTodayModule();
}

function renderTodos(){
  const list = activeTodoList();
  const filter = $("todoFilter").value;
  const sort = $("todoSort").value;

  let todos = list.todos.slice();

  if(filter==="open") todos = todos.filter(t=>!t.doneAt);
  if(filter==="done") todos = todos.filter(t=>!!t.doneAt);

  if(sort==="priority"){
    todos.sort((a,b)=> b.priority-a.priority || (a.estimateMin-b.estimateMin) || (b.createdAt-a.createdAt));
  }else if(sort==="estimate"){
    todos.sort((a,b)=> a.estimateMin-b.estimateMin || (b.priority-a.priority) || (b.createdAt-a.createdAt));
  }else{
    todos.sort((a,b)=> b.createdAt-a.createdAt);
  }

  const wrap = $("todoList");
  wrap.innerHTML="";

  if(todos.length===0){
    const empty=document.createElement("div");
    empty.className="help";
    empty.textContent="å½“å‰ç­›é€‰ä¸‹æ²¡æœ‰ To-Doã€‚ä½ å¯ä»¥æ·»åŠ ä¸€ä¸ªâ€œç°åœ¨å°±èƒ½å¼€å§‹â€çš„æœ€å°åŠ¨ä½œã€‚";
    wrap.appendChild(empty);
    return;
  }

  todos.forEach(t=>{
    const item=document.createElement("div");
    item.className="item";
    item.style.borderColor = (selectedTodoId===t.id) ? "rgba(96,165,250,.50)" : "rgba(255,255,255,.08)";

    const top=document.createElement("div");
    top.className="itemTop";

    const left=document.createElement("div");
    const title=document.createElement("div");
    title.className="itemTitle";
    title.textContent = t.title;
    const meta=document.createElement("div");
    meta.className="small";
    const prTxt = t.priority===2?"é«˜":(t.priority===1?"ä¸­":"ä½");
    meta.textContent = `åˆ†ç±»ï¼š${t.cat} Â· ä¼˜å…ˆçº§ï¼š${prTxt} Â· é¢„è®¡ï¼š${t.estimateMin}min`;
    left.appendChild(title);
    left.appendChild(meta);

    const right=document.createElement("div");
    right.className="row";
    right.style.flex="0 0 auto";
    right.style.gap="8px";

    const selectBtn=document.createElement("button");
    selectBtn.className="btnGhost";
    selectBtn.textContent = (selectedTodoId===t.id) ? "å·²é€‰ä¸­" : "é€‰ä¸­";
    selectBtn.onclick=()=>{
      selectedTodoId = (selectedTodoId===t.id) ? null : t.id;
      renderTodos();
    };

    const doneBtn=document.createElement("button");
    doneBtn.className = t.doneAt ? "btn2" : "";
    doneBtn.textContent = t.doneAt ? "å·²å®Œæˆ" : "å®Œæˆ";
    doneBtn.onclick=()=>toggleTodoDone(t.id);

    const editBtn=document.createElement("button");
    editBtn.className="btnGhost";
    editBtn.textContent="ç¼–è¾‘";
    editBtn.onclick=()=>editTodo(t.id);

    const delBtn=document.createElement("button");
    delBtn.className="btnDanger";
    delBtn.textContent="åˆ ";
    delBtn.onclick=()=>deleteTodo(t.id);

    right.appendChild(selectBtn);
    right.appendChild(doneBtn);
    right.appendChild(editBtn);
    right.appendChild(delBtn);

    top.appendChild(left);
    top.appendChild(right);
    item.appendChild(top);

    wrap.appendChild(item);
  });
}

function fillSelectedTodoIntoBlock(){
  const list = activeTodoList();
  const t = list.todos.find(x=>x.id===selectedTodoId);
  if(!t) return toast("å…ˆé€‰ä¸­ä¸€ä¸ª To-Do");
  $("goalInput").value = t.title;
  $("blockCat").value = t.cat;
  toast("å·²å¡«å…¥æ‰§è¡Œå—ç›®æ ‡");
  setActiveTab("block");
}

/* =========================
   Blocks / logs
   ========================= */
function updateTimerUI(){
  $("timeDisplay").textContent = fmtTime(timer.remainingMs);
  if(timer.running){
    $("blockMeta").textContent = `è¿›è¡Œä¸­ Â· ${$("blockType").value==="deep"?"æ ‡å‡†å—":"è½»é‡å—"} Â· ${$("blockCat").value}`;
  }else if(timer.startedAt){
    $("blockMeta").textContent = `å·²æš‚åœ Â· ${$("blockType").value==="deep"?"æ ‡å‡†å—":"è½»é‡å—"} Â· ${$("blockCat").value}`;
  }else{
    $("blockMeta").textContent = "æœªå¼€å§‹";
  }
}

function startBlock(){
  const goal = $("goalInput").value.trim();
  if(!goal) return toast("å…ˆå†™æ¸…æœ¬æ‰§è¡Œå—ç›®æ ‡");
  const anchor = $("anchorSelect").value;
  toast("å¯åŠ¨é”šç‚¹ï¼š" + anchor);

  timer.totalMs = getBlockTotalMs($("blockType").value);
  if(!timer.startedAt || timer.remainingMs<=0){
    timer.startedAt = Date.now();
    timer.remainingMs = timer.totalMs;
  }else{
    // resume
    timer.startedAt = Date.now() - (timer.totalMs - timer.remainingMs);
  }
  timer.running = true;
  updateTimerUI();
  startTick();
}
function pauseBlock(){
  if(!timer.startedAt) return toast("è¿˜æ²¡å¼€å§‹");
  if(!timer.running) return toast("å½“å‰å·²æš‚åœ");
  const elapsed = Date.now() - timer.startedAt;
  timer.remainingMs = Math.max(0, timer.totalMs - elapsed);
  timer.running = false;
  updateTimerUI();
  toast("å·²æš‚åœ");
}
function finishBlock({useTimer=true}={}){
  const goal = $("goalInput").value.trim();
  const out = $("outputInput").value.trim();
  if(!goal) return toast("ç›®æ ‡ä¸èƒ½ä¸ºç©º");
  if(!out) return toast("ç¡¬è¾“å‡ºä¸èƒ½ä¸ºç©ºï¼ˆå†™å®Œæ‰ç®—å®Œæˆï¼‰");

  const type = $("blockType").value;
  const durationMin = (type==="light"?45:90);
  const cat = $("blockCat").value || "æœªåˆ†ç±»";

  const log = {
    id: crypto.randomUUID(),
    date: todayKey(),
    time: nowHM(),
    cat,
    type,
    durationMin,
    goal,
    output: out
  };

  const day = ensureDay();
  day.logs.push(log);
  saveState();

  const micro = $("microReward").value;
  toast("å®Œæˆï¼å¾®å¥–åŠ±ï¼š" + micro);

  if(shouldTriggerDailyReward()){
    setTimeout(()=>toast("å·²è¾¾æˆå½“æ—¥å¥–åŠ±æ¡ä»¶ï¼šå»é¢†å–å§ ğŸ"), 650);
  }
  if(shouldTriggerWeeklyReward()){
    setTimeout(()=>toast("å‘¨æœŸå¥–åŠ±æ¡ä»¶å·²æ»¡è¶³ï¼šå®‰æ’ä¸€æ¬¡è¡¥å¿å¥–åŠ± ğŸ‰"), 1100);
  }

  $("outputInput").value="";
  if(useTimer) resetTimer();

  refreshAll();
}

/* =========================
   Plan / rewards / streak
   ========================= */
function dayRate(dayObj){
  const plan = Number(dayObj.planBlocks)||0;
  const done = (dayObj.logs||[]).length;
  return plan>0 ? done/plan : 1;
}
function calcStreak(){
  const threshold = state.settings.streakRateThreshold ?? 0.70;
  let streak = 0;
  let d = new Date();
  for(let i=0;i<365;i++){
    const key = todayKey(d);
    const day = state.days[key];
    if(!day) break;
    if(dayRate(day) >= threshold){
      streak++;
      d.setDate(d.getDate()-1);
    }else break;
  }
  return streak;
}
function shouldTriggerDailyReward(){
  const day = ensureDay();
  const done = day.logs.length;
  const thr = Number(day.dailyRewardThreshold ?? state.settings.dailyRewardThreshold ?? 2);
  return done >= thr && !day.dailyClaimed;
}
function shouldTriggerWeeklyReward(){
  const needDays = state.settings.weeklyStreakDays ?? 3;
  const streak = calcStreak();
  if(streak < needDays) return false;
  if(state.weeklyRewardLastClaimedAt){
    const last = new Date(state.weeklyRewardLastClaimedAt);
    const diffDays = (Date.now()-last.getTime())/(1000*60*60*24);
    if(diffDays < 7) return false;
  }
  return true;
}

function loadPlanToInputs(){
  const day = ensureDay();
  $("planBlocks").value = day.planBlocks;
  $("dailyRewardThreshold").value = day.dailyRewardThreshold ?? (state.settings.dailyRewardThreshold ?? 2);
}
function savePlan(){
  const day = ensureDay();
  day.planBlocks = Math.max(0, Number($("planBlocks").value)||0);
  day.dailyRewardThreshold = Math.max(0, Number($("dailyRewardThreshold").value)||0);
  state.settings.dailyRewardThreshold = day.dailyRewardThreshold;
  saveState();
  toast("å·²ä¿å­˜ä»Šæ—¥è®¡åˆ’");
  refreshAll();
}
function claimDaily(){
  const day = ensureDay();
  day.dailyClaimed = true;
  saveState();
  toast("å·²æ ‡è®°ï¼šå½“æ—¥å¥–åŠ±å·²é¢†å–");
  refreshAll();
}
function claimWeekly(){
  state.weeklyRewardLastClaimedAt = new Date().toISOString();
  saveState();
  toast("å·²æ ‡è®°ï¼šå‘¨æœŸå¥–åŠ±å·²é¢†å–");
  refreshAll();
}

function updateKPIs(){
  const day = ensureDay();
  const done = day.logs.length;
  const plan = Number(day.planBlocks)||0;
  const rate = plan>0 ? done/plan : 1;
  $("kpiBlocks").textContent = done;
  $("kpiRate").textContent = `${Math.round(rate*100)}%`;
  $("kpiStreak").textContent = calcStreak().toString();
}
function updateRewardStatus(){
  const day = ensureDay();
  const done = day.logs.length;
  const plan = Number(day.planBlocks)||0;
  const rate = plan>0 ? done/plan : 1;
  const streak = calcStreak();
  const thr = Number(day.dailyRewardThreshold ?? state.settings.dailyRewardThreshold ?? 2);

  let lines = [];
  lines.push(`ä»Šæ—¥ï¼šå®Œæˆ <b>${done}</b> å— / è®¡åˆ’ <b>${plan}</b> å—ï¼Œå®Œæˆç‡ <b>${Math.round(rate*100)}%</b>ã€‚`);
  if(plan===0){
    lines.push(`<span class="hl-warn">æç¤ºï¼š</span>ä»Šæ—¥è®¡åˆ’ä¸º 0ï¼Œå®Œæˆç‡æŒ‰ 100% å¤„ç†ï¼ˆå»ºè®®è®¾å®šè®¡åˆ’æ›´æœ‰â€œç³»ç»Ÿæ„Ÿâ€ï¼‰ã€‚`);
  }
  if(day.dailyClaimed){
    lines.push(`<span class="hl-good">å½“æ—¥è¾¾æˆå¥–åŠ±ï¼š</span>å·²é¢†å– âœ…ï¼ˆé˜ˆå€¼ â‰¥${thr} å—ï¼‰`);
  }else if(done >= thr){
    lines.push(`<span class="hl-good">å½“æ—¥è¾¾æˆå¥–åŠ±ï¼š</span>å·²è¾¾æˆï¼ç°åœ¨å°±å»é¢†å–ï¼ˆé˜ˆå€¼ â‰¥${thr} å—ï¼‰ã€‚`);
  }else{
    lines.push(`å½“æ—¥è¾¾æˆå¥–åŠ±ï¼šè¿˜å·® <b>${Math.max(0, thr-done)}</b> å—è§¦å‘ï¼ˆé˜ˆå€¼ â‰¥${thr} å—ï¼‰ã€‚`);
  }
  lines.push(`è¿ç»­è¾¾æ ‡å¤©æ•°ï¼ˆâ‰¥70%ï¼‰ï¼š<b>${streak}</b> å¤©ã€‚`);
  if(shouldTriggerWeeklyReward()){
    lines.push(`<span class="hl-good">å‘¨æœŸè¡¥å¿å¥–åŠ±ï¼š</span>å·²æ»¡è¶³æ¡ä»¶ï¼ˆè¿ç»­ 3 å¤© â‰¥70%ï¼‰ã€‚å»ºè®®æœ¬å‘¨å®‰æ’ä¸€æ¬¡â€œæ— å†…ç–šå¥–åŠ±â€ã€‚`);
  }else{
    lines.push(`å‘¨æœŸè¡¥å¿å¥–åŠ±ï¼šæ¡ä»¶ä¸ºè¿ç»­ 3 å¤© â‰¥70%ï¼Œæœ¬å‘¨å°šæœªè§¦å‘æˆ–å·²é¢†å–ã€‚`);
  }
  $("rewardStatus").innerHTML = lines.join("<br/>");
}

/* =========================
   Today module
   ========================= */
function renderTodayModule(){
  const day = ensureDay();
  const doneWrap = $("todayDoneTodos");
  const blocksWrap = $("todayBlocksList");
  doneWrap.innerHTML="";
  blocksWrap.innerHTML="";

  // Done todos today (collect from all lists by id)
  const doneIds = new Set(day.todoDoneIds || []);
  const doneTodos = [];
  state.todoLists.forEach(list=>{
    list.todos.forEach(t=>{
      if(doneIds.has(t.id)) doneTodos.push({ ...t, listName:list.name });
    });
  });

  if(doneTodos.length===0){
    const empty=document.createElement("div");
    empty.className="help";
    empty.textContent="ä»Šå¤©è¿˜æ²¡æœ‰å®Œæˆ To-Doã€‚å» To-Do é¡µå®Œæˆä¸€ä¸ªæœ€å°åŠ¨ä½œï¼Œä»Šå¤©å°±â€œæœ‰è¿›å±•â€äº†ã€‚";
    doneWrap.appendChild(empty);
  }else{
    doneTodos.sort((a,b)=>(b.doneAt||0)-(a.doneAt||0));
    doneTodos.forEach(t=>{
      const item=document.createElement("div");
      item.className="item";
      const top=document.createElement("div");
      top.className="itemTop";
      const left=document.createElement("div");
      const title=document.createElement("div");
      title.className="itemTitle";
      title.textContent=t.title;
      const meta=document.createElement("div");
      meta.className="small";
      meta.textContent=`æ¥è‡ªï¼š${t.listName} Â· åˆ†ç±»ï¼š${t.cat} Â· ${t.estimateMin}min`;
      left.appendChild(title); left.appendChild(meta);
      const tag=document.createElement("div");
      tag.className="tag";
      tag.textContent="å®Œæˆ âœ…";
      top.appendChild(left); top.appendChild(tag);
      item.appendChild(top);
      doneWrap.appendChild(item);
    });
  }

  // Blocks today
  if(day.logs.length===0){
    const empty=document.createElement("div");
    empty.className="help";
    empty.textContent="ä»Šå¤©è¿˜æ²¡æœ‰å®Œæˆæ‰§è¡Œå—ã€‚å³ä½¿çŠ¶æ€å·®ï¼Œä¹Ÿå¯ä»¥ç”¨â€œè½»é‡å— 45 åˆ†é’Ÿâ€ã€‚";
    blocksWrap.appendChild(empty);
  }else{
    day.logs.slice().reverse().forEach(log=>{
      const item=document.createElement("div");
      item.className="item";
      const top=document.createElement("div");
      top.className="itemTop";
      const left=document.createElement("div");
      const title=document.createElement("div");
      title.className="itemTitle";
      title.textContent = `${log.cat} Â· ${log.type==="deep"?"æ ‡å‡†å—":"è½»é‡å—"} Â· ${log.durationMin}min`;
      const meta=document.createElement("div");
      meta.className="small";
      meta.textContent = `${log.time} Â· ç›®æ ‡ï¼š${log.goal}`;
      left.appendChild(title); left.appendChild(meta);
      const tag=document.createElement("div");
      tag.className="tag";
      tag.textContent="å®Œæˆ âœ…";
      top.appendChild(left); top.appendChild(tag);
      const body=document.createElement("div");
      body.className="itemBody";
      body.textContent = `ç¡¬è¾“å‡ºï¼š\n${log.output}`;
      item.appendChild(top);
      item.appendChild(body);
      blocksWrap.appendChild(item);
    });
  }
}

/* =========================
   Chart
   ========================= */
function roundRect(ctx, x, y, w, h, r, fillStyle, strokeStyle){
  const radius = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+radius, y);
  ctx.arcTo(x+w, y, x+w, y+h, radius);
  ctx.arcTo(x+w, y+h, x, y+h, radius);
  ctx.arcTo(x, y+h, x, y, radius);
  ctx.arcTo(x, y, x+w, y, radius);
  ctx.closePath();
  ctx.fillStyle = fillStyle;
  ctx.fill();
  if(strokeStyle){
    ctx.strokeStyle = strokeStyle;
    ctx.lineWidth = 1;
    ctx.stroke();
  }
}
function drawChart(){
  const canvas = $("chart");
  const ctx = canvas.getContext("2d");
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0,0,w,h);

  const keys=[];
  const d=new Date(); d.setHours(12,0,0,0);
  for(let i=6;i>=0;i--){
    const t=new Date(d); t.setDate(d.getDate()-i);
    keys.push(todayKey(t));
  }
  const vals = keys.map(k=>{
    const day = state.days[k];
    if(!day) return null;
    return Math.max(0, Math.min(1, dayRate(day)));
  });

  const pad=28;
  const innerW=w-pad*2;
  const innerH=h-pad*2;
  const barW=innerW/7*0.65;
  const gap=innerW/7*0.35;

  ctx.strokeStyle="rgba(255,255,255,.12)";
  ctx.lineWidth=2;
  ctx.beginPath();
  ctx.moveTo(pad,pad);
  ctx.lineTo(pad,h-pad);
  ctx.lineTo(w-pad,h-pad);
  ctx.stroke();

  // grid
  ctx.strokeStyle="rgba(255,255,255,.08)";
  ctx.lineWidth=1;
  [0,0.5,1].forEach(g=>{
    const y=h-pad-g*innerH;
    ctx.beginPath();
    ctx.moveTo(pad,y);
    ctx.lineTo(w-pad,y);
    ctx.stroke();
  });

  for(let i=0;i<7;i++){
    const x=pad + i*(barW+gap) + gap/2;
    const v=vals[i];
    const barH = v==null ? innerH*0.08 : innerH*v;
    const y = h-pad-barH;

    let fill="rgba(147,164,199,.25)";
    if(v!=null){
      if(v>=0.70) fill="rgba(74,222,128,.45)";
      else if(v>=0.40) fill="rgba(251,191,36,.40)";
      else fill="rgba(251,113,133,.40)";
    }
    roundRect(ctx,x,y,barW,barH,10,fill,"rgba(255,255,255,.10)");

    ctx.fillStyle="rgba(147,164,199,.85)";
    ctx.font="20px ui-monospace, Menlo, Monaco, Consolas, monospace";
    ctx.fillText(keys[i].slice(5), x, h-pad+22);

    ctx.fillStyle="rgba(234,240,255,.92)";
    ctx.font="22px ui-monospace, Menlo, Monaco, Consolas, monospace";
    const txt = v==null ? "-" : `${Math.round(v*100)}%`;
    ctx.fillText(txt, x, y-8);
  }

  const y70 = h-pad-0.70*innerH;
  ctx.strokeStyle="rgba(96,165,250,.65)";
  ctx.setLineDash([10,8]);
  ctx.lineWidth=2;
  ctx.beginPath();
  ctx.moveTo(pad,y70);
  ctx.lineTo(w-pad,y70);
  ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle="rgba(96,165,250,.90)";
  ctx.font="18px ui-monospace, Menlo, Monaco, Consolas, monospace";
  ctx.fillText("70% çº¿", pad+6, y70-8);
}

/* =========================
   Export / Reset
   ========================= */
function exportJSON(){
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "execution_os_export.json";
  a.click();
  URL.revokeObjectURL(url);
  toast("å·²å¯¼å‡º");
}
function resetAll(){
  if(!confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿä¸å¯æ’¤é”€ã€‚")) return;
  localStorage.removeItem(STORE_KEY);
  toast("å·²æ¸…ç©ºï¼Œåˆ·æ–°é¡µé¢ç”Ÿæ•ˆ");
  location.reload();
}

/* =========================
   Refresh
   ========================= */
function refreshAll(){
  setTodayPill();
  ensureDay();
  populateTodoLists();
  populateCategories();
  loadPlanToInputs();
  updateKPIs();
  updateRewardStatus();
  renderTodos();
  renderTodayModule();
  drawChart();
}

/* =========================
   PWA install
   ========================= */
let deferredPrompt = null;
function setupPWA(){
  // Register SW
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }

  const bar = $("installBar");
  const installBtn = $("installBtn");
  const dismissBtn = $("dismissInstallBtn");

  window.addEventListener("beforeinstallprompt", (e)=>{
    e.preventDefault();
    deferredPrompt = e;
    bar.style.display="flex";
  });

  installBtn.addEventListener("click", async ()=>{
    if(!deferredPrompt) return toast("å½“å‰ç¯å¢ƒä¸æ”¯æŒå®‰è£…ï¼ˆè¯·ç”¨ https æˆ– localhostï¼‰");
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    deferredPrompt = null;
    bar.style.display="none";
    toast(outcome === "accepted" ? "å·²å¼€å§‹å®‰è£…" : "å·²å–æ¶ˆå®‰è£…");
  });

  dismissBtn.addEventListener("click", ()=>{
    bar.style.display="none";
    toast("å¥½çš„ï¼Œä¹‹åä¹Ÿå¯ä»¥å†å®‰è£…");
  });
}

/* =========================
   Wire up
   ========================= */
window.addEventListener("load", ()=>{
  // Tabs
  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=>setActiveTab(t.dataset.tab));
  });
  setActiveTab(state.ui.activeTab || "todo");

  // Category modal
  $("manageCatsBtn").addEventListener("click", openCatModal);
  $("closeCatModalBtn").addEventListener("click", closeCatModal);
  $("catModalMask").addEventListener("click", (e)=>{
    if(e.target === $("catModalMask")) closeCatModal();
  });
  $("addCatBtn").addEventListener("click", addCategory);

  // To-Do lists
  $("todoListSelect").addEventListener("change", (e)=>{
    state.ui.activeTodoListId = e.target.value;
    selectedTodoId = null;
    saveState();
    renderTodos();
  });
  $("addListBtn").addEventListener("click", addTodoList);
  $("renameListBtn").addEventListener("click", renameTodoList);
  $("deleteListBtn").addEventListener("click", deleteTodoList);

  // To-Do items
  $("addTodoBtn").addEventListener("click", addTodo);
  $("todoFilter").addEventListener("change", renderTodos);
  $("todoSort").addEventListener("change", renderTodos);
  $("addToBlockBtn").addEventListener("click", fillSelectedTodoIntoBlock);

  // Blocks
  $("startBtn").addEventListener("click", startBlock);
  $("pauseBtn").addEventListener("click", pauseBlock);
  $("finishBtn").addEventListener("click", ()=>finishBlock({useTimer:true}));
  $("quickLogBtn").addEventListener("click", ()=>finishBlock({useTimer:false}));
  $("quickLightBtn").addEventListener("click", ()=>{
    $("blockType").value="light";
    toast("å·²åˆ‡æ¢ï¼šè½»é‡å—");
    updateTimerUI();
  });
  $("quickDeepBtn").addEventListener("click", ()=>{
    $("blockType").value="deep";
    toast("å·²åˆ‡æ¢ï¼šæ ‡å‡†å—");
    updateTimerUI();
  });
  $("blockType").addEventListener("change", ()=>updateTimerUI());
  $("blockCat").addEventListener("change", ()=>updateTimerUI());

  // Plan / rewards
  $("savePlanBtn").addEventListener("click", savePlan);
  $("claimDailyBtn").addEventListener("click", claimDaily);
  $("claimWeeklyBtn").addEventListener("click", claimWeekly);

  // Export / reset
  $("exportBtn").addEventListener("click", exportJSON);
  $("resetBtn").addEventListener("click", resetAll);

  // init
  ensureDay();
  resetTimer();
  refreshAll();
  setupPWA();

  // redraw on resize
  window.addEventListener("resize", ()=>drawChart());
});
</script>
</body>
</html>